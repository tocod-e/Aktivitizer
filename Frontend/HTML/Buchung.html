<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <title>Buchung</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link type="text/css" href="../CSS/Homepage.css" rel="stylesheet" />

    <link type="text/css" href="../CSS/Footer.css" rel="stylesheet" />
    <link type="text/css" href="../CSS/Buchung.css" rel="stylesheet" />


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <script src="../JS/Buchung.js" defer></script>
  </head>

  <body onload="checkToken()" style="display: none">
    <header>
      <div class="logo-container">
        <img src="/homepage/logo.png" alt="Logo" />
        <h1 class="logo-title">
          <span class="logo-name">Aktiv</span>
          <span class="normal-letters">itizer </span>
        </h1>
      </div>

      <nav class="navbar">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a href="/home" class="nav-link">Home</a>
          </li>
          <li class="nav-item">
            <a href="/kontaktformular" class="nav-link">Contact</a>
          </li>
          <li class="nav-item">
            <a href="/about" class="nav-link">About</a>
          </li>

          <div class="dropdown">
            <a
              href="#"
              class="dropdown-toggle"
              id="dropdownMenuButton"
              data-toggle="dropdown"
            >
              <img src="/homepage/user.png" alt="DropdownMenu" width="30px" />
            </a>

            <div class="dropdown-menu dropdown-menu-fixed">
              <a
                class="dropdown-item dropdown_menue meine_buchungen"
                href="/kontoansicht"
                >Meine Buchungen</a
              >
              <a
                class="dropdown-item dropdown_menue zahlungsdetails_"
                href="/kontoansicht"
                >Zahlungsdetails</a
              >
              <a
                class="dropdown-item dropdown_menue aktivitaet_erstellen"
                href="/kontoansicht"
                >Aktivität erstellen</a
              >
              <a
                class="dropdown-item dropdown_menue meine_erstellten_aktivitaeten"
                href="/kontoansicht"
                >Meine Erstellten Aktivitäten
              </a>
              <div class="dropdown-divider dropdown_menue"></div>
              <a class="dropdown-item dropdown_menue" href="/kontoansicht"
                >Mein Konto</a
              >
              <a class="dropdown-item" id="dropdown_login" href="/login"
                >Login/Registrierung</a
              >
              <a
                class="dropdown-item"
                id="dropdown_logout"
                href="/home"
                onclick="logoutUser()"
                >Logout</a
              >
            </div>
          </div>
        </ul>
      </nav>
    </header>
    <hr class="separator" />

    <main>
      <div class="container">
        <div class="text-sm" style="margin-bottom: 20px">
          <i class="fa fa-angle-left"></i>
          <a href="#" onclick="redirectToDetails()">Details</a>
        </div>

        <h4 class="lg-font-size"><span id="titel"></span></h4>
        <p class="text mt-4">
          Hier ganz einfach nach verfügbaren Terminen suchen und das passende
          Datum buchen.
        </p>

        <div class="row">
          <div class="col-md-4">
            <div class="row">
              <div class="col">
                <div style="font-size: 1.4rem">
                  Datum und Uhrzeit wählen
                  <hr style="width: 650px" />
                </div>

                <div class="wrapper">
                  <header>
                    <div class="icons">
                      <span id="prev" class="material-symbols-rounded"
                        >chevron_left</span
                      >
                      <p class="current-date"></p>
                      <span id="next" class="material-symbols-rounded"
                        >chevron_right</span
                      >
                    </div>
                  </header>
                  <div class="calendar">
                    <ul class="weeks">
                      <li>Sun</li>
                      <li>Mon</li>
                      <li>Tue</li>
                      <li>Wed</li>
                      <li>Thu</li>
                      <li>Fri</li>
                      <li>Sat</li>
                    </ul>
                    <ul class="days"></ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="row">
              <div class="col">
                <div style="margin-top: 8px">
                  Mitteleuropäische Sommerzeit(MESZ)
                </div>

                <div style="padding-top: 25px">
                  <input type="text" id="selectedDate" readonly />
                  <!--<div>Keine Verfügbarkeit</div>-->
                  <button
                    class="btn btn-primary search-button"
                    style="margin-left: -5px; width: 65%; margin-top: 45px"
                    onclick="getNextAvailableDate()"
                  >
                    Nächsten Termin finden
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4" style="margin-left: -35px; margin-top: 5px">
            <div class="row">
              <div class="col">
                <div>
                  <a href="#" class="">
                    Servicedetails
                    
                  </a>
                </div>
                <div style="padding-top: 20px">
                  <div style="display: flex; gap: 45px;">
                    <p>Preis: <br /><span id="preis"></span>€</p>
                    <p>Anzahl Personen: <br /><select id="personAmountDropdown" style="width: 50px;"></select></p>
                    <p>Dauer: <br /><span id="duration"></span>h</p>
                  </div>
                  <div style="display: flex;">
                    <p>Ort: <br /><span id="ort"></span></p>
                  </div>
                  <p>Zeitraum: <br /><span id="datum"></span></p>
                </div>
                <hr />
                <button
                  class="btn btn-primary search-button"
                  style="width: 100%; margin-top: 12px"
                  onclick="checkout()"
                >
                  Buchen
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <br /><br /><br /><br />
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <span class="copyright">©2023 Aktivitizer</span>
          </div>
          <div class="col-md-6">
            <a class="privacy-policy" href="#">Privacy Policy</a>
          </div>
        </div>
      </div>
    </footer>
    <script>
      function profil_Kunde() {
        $(document).ready(function () {
          $.ajax({
            url: "http://localhost:8000/api/kunde/profil",
            type: "get",
            headers: {
              Authorization: "Bearer " + sessionStorage.getItem("accessToken"),
            },
          })
            .done(function (response) {
              console.log(response);
              //console.log(response.rolleId);
              if (response.rolleId === 2) {
                //Kunde = 2, Unternehmen = 3
                var aktivitaetErstellenTabs = document.getElementsByClassName(
                  "aktivitaet_erstellen"
                );
                var meineErstelltenAktivitaetenTabs =
                  document.getElementsByClassName(
                    "meine_erstellten_aktivitaeten"
                  );

                Array.from(aktivitaetErstellenTabs).forEach(function (tab) {
                  tab.style.display = "none";
                });

                Array.from(meineErstelltenAktivitaetenTabs).forEach(function (
                  tab
                ) {
                  tab.style.display = "none";
                });
              } else if (response.rolleId === 3) {
                var zahlungsdetailsTabs =
                  document.getElementsByClassName("zahlungsdetails_");
                var meineBuchungenTabs =
                  document.getElementsByClassName("meine_buchungen");

                Array.from(meineBuchungenTabs).forEach(function (tab) {
                  tab.style.display = "none";
                });

                Array.from(zahlungsdetailsTabs).forEach(function (tab) {
                  tab.style.display = "none";
                });
              }
            })
            .fail(function (jqXHR, statusText, error) {
              //console.error('Fehler beim Abrufen der Benutzerdaten:', statusText, error);
              return false;
            });
        });
      }
      function profil_Unternehmen() {
        $(document).ready(function () {
          $.ajax({
            url: "http://localhost:8000/api/unternehmen/profil",
            type: "get",
            headers: {
              Authorization: "Bearer " + sessionStorage.getItem("accessToken"),
            },
          })
            .done(function (response) {
              console.log(response);
              //console.log(response.rolleId);
              if (response.rolleId === 2) {
                //Kunde = 2, Unternehmen = 3
                var aktivitaetErstellenTabs = document.getElementsByClassName(
                  "aktivitaet_erstellen"
                );
                var meineErstelltenAktivitaetenTabs =
                  document.getElementsByClassName(
                    "meine_erstellten_aktivitaeten"
                  );

                Array.from(aktivitaetErstellenTabs).forEach(function (tab) {
                  tab.style.display = "none";
                });

                Array.from(meineErstelltenAktivitaetenTabs).forEach(function (
                  tab
                ) {
                  tab.style.display = "none";
                });
              } else if (response.rolleId === 3) {
                var zahlungsdetailsTabs =
                  document.getElementsByClassName("zahlungsdetails_");
                var meineBuchungenTabs =
                  document.getElementsByClassName("meine_buchungen");

                Array.from(meineBuchungenTabs).forEach(function (tab) {
                  tab.style.display = "none";
                });

                Array.from(zahlungsdetailsTabs).forEach(function (tab) {
                  tab.style.display = "none";
                });
              }
            })
            .fail(function (jqXHR, statusText, error) {
              //console.error('Fehler beim Abrufen der Benutzerdaten:', statusText, error);
              return false;
            });
        });
      }
      function checkToken() {
        const accessToken = sessionStorage.getItem("accessToken");
        if (!accessToken) {
          var dropdown_m = document.getElementsByClassName("dropdown_menue");

          Array.from(dropdown_m).forEach(function (tab) {
            tab.style.display = "none";
          });
          document.getElementById("dropdown_logout").style.display = "none";
        } else {
          document.getElementById("dropdown_login").style.display = "none";
          profil_Kunde();
          profil_Unternehmen();

          const jwtPayload = JSON.parse(window.atob(accessToken.split(".")[1]));
          const datetime = new Date(jwtPayload.exp * 1000);
          console.log("expiry time (epoch):", jwtPayload.exp * 1000);
          console.log("expiry time (ISO):", datetime.toISOString());
          const isExpired = Date.now() >= jwtPayload.exp * 1000;
          console.log("token is expired:", isExpired);
          if (isExpired == true) {
            window.location = "/login";
          } else {
            document.getElementsByTagName("body")[0].style.display = "block";
          }
        }
      }
      function logoutUser() {
        sessionStorage.removeItem("accessToken");
      }
      function params() {
        const urlParams = new URLSearchParams(window.location.search);
        const activityParams = urlParams.get('activity');
        const activity = JSON.parse(decodeURIComponent(activityParams));
        document.getElementById("titel").innerText = activity.name;
        //
        //
        document.getElementById("datum").innerText = activity.date;
        //
        document.getElementById("preis").innerHTML = activity.price;
        document.getElementById("duration").innerHTML = activity.duration;

        // Parameter person_amount erhalten (kannst du anpassen)
        const personAmount = activity.person_amount; // Hier setze den Wert entsprechend deiner Anforderung
        const dropdown = document.getElementById("personAmountDropdown");

        // Schleife, um Optionen für das Dropdown-Menü zu erstellen und hinzuzufügen
        for (let i = 1; i <= personAmount; i++) {
            const option = document.createElement("option");
            option.value = i;
            option.text = i;
            dropdown.appendChild(option);
        }
        function updatePrice() {
          const selectedAmount = document.getElementById("personAmountDropdown").value;
          const totalPrice = activity.price * selectedAmount;

          document.getElementById("preis").innerText = totalPrice;
        }
        
        document.getElementById("personAmountDropdown").addEventListener('change', updatePrice);
        document.getElementById("ort").innerText = activity.plz + ' ' + activity.city;

        console.log(activity.id); // Zugriff auf die Aktivitäts-ID
        console.log(activity.name); // Zugriff auf den Aktivitätsnamen
      }
      
      document.addEventListener('DOMContentLoaded', (event) => {
          params(); // Hier wird params() aufgerufen, wenn das DOM vollständig geladen ist
      });
      function redirectToDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const activityParams = urlParams.get('activity');
        const activity = JSON.parse(decodeURIComponent(activityParams));
        // Baue die URL mit dem Parameter auf
        const url = `/aktivitaetsansicht?activity=${activityParams}`;

        // Weiterleitung zur nächsten Seite mit dem Parameter in der URL
        window.location.href = url;
      }

      function checkout() {
          const width = 400;
          const height = 300;
          const left = window.innerWidth / 2 - width / 2;
          const top = window.innerHeight / 2 - height / 2;
          
          const windowFeatures = `width=${width},height=${height},left=${left},top=${top}`;
          
          window.open('about:blank', 'NeuesFenster', windowFeatures);
      }

    </script>
  </body>
</html>
